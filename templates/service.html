{% extends "base.html" %}
{% block title %}Service Predictor â€” VehicleAI{% endblock %}

{% block content %}
<div class="page-hero">
  <div class="overline">Module 02 â€” Service Intelligence</div>
  <h1>Service Cost <span>Predictor</span></h1>
  <p>Enter vehicle details to predict service cost and identify exactly which maintenance items need attention â€” powered by Random Forest models trained on 1,139 real service records.</p>
</div>

<div class="section">
  <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:28px; align-items:start;">

    <!-- FORM -->
    <div class="card">
      <div class="card-head">Vehicle Information</div>
      <div class="form-grid" style="grid-template-columns:1fr 1fr;">

        <div class="field">
          <label>Brand</label>
          <select id="v-brand" onchange="updateModels()">
            <option value="">Select brand</option>
            {% for b in stats.brands %}<option value="{{ b }}">{{ b | title }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Model</label>
          <select id="v-model">
            <option value="">Select model</option>
            {% for m in stats.models %}<option value="{{ m }}">{{ m | title }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Engine Type</label>
          <select id="v-engine">
            <option value="">Select type</option>
            {% for e in stats.engine_types %}<option value="{{ e }}">{{ e | title }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Region</label>
          <select id="v-region">
            <option value="">Select region</option>
            {% for r in stats.regions %}<option value="{{ r }}">{{ r | title }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Make Year</label>
          <select id="v-year">
            <option value="">Select year</option>
            {% for y in stats.years %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Mileage Range (km)</label>
          <select id="v-mileage-range">
            {% for mr in stats.mileage_ranges %}<option value="{{ mr }}">{{ mr }} km service</option>{% endfor %}
          </select>
        </div>

        <div class="field" style="grid-column:1/-1;">
          <label>Current Mileage (km)</label>
          <input type="number" id="v-mileage" placeholder="e.g. 45000" min="0" max="500000">
          <span class="hint">Odometer reading</span>
        </div>
      </div>

      <div style="margin-top:24px; display:flex; gap:12px; flex-wrap:wrap;">
        <button class="btn btn-primary" id="predict-btn" onclick="runServicePredict()">
          ðŸ”§ Predict Maintenance
        </button>
        <button class="btn btn-ghost" onclick="loadServiceSample()">Load Sample</button>
        <button class="btn btn-ghost" onclick="clearServiceForm()">Clear</button>
      </div>

      <!-- Dataset Stats -->
      <div style="margin-top:24px; padding-top:20px; border-top:1px solid var(--border);">
        <div class="card-head" style="margin-bottom:12px;">Dataset Coverage</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div style="background:var(--bg3); border-radius:6px; padding:12px; text-align:center;">
            <div class="font-display fw-700" style="font-size:22px; color:var(--accent);">{{ stats.brands | length }}</div>
            <div class="text-xs text-muted">Brands</div>
          </div>
          <div style="background:var(--bg3); border-radius:6px; padding:12px; text-align:center;">
            <div class="font-display fw-700" style="font-size:22px; color:var(--success);">{{ stats.models | length }}</div>
            <div class="text-xs text-muted">Models</div>
          </div>
          <div style="background:var(--bg3); border-radius:6px; padding:12px; text-align:center;">
            <div class="font-display fw-700" style="font-size:22px; color:var(--warning);">â‚¹{{ stats.avg_cost | default(3200) }}</div>
            <div class="text-xs text-muted">Avg Service Cost</div>
          </div>
          <div style="background:var(--bg3); border-radius:6px; padding:12px; text-align:center;">
            <div class="font-display fw-700" style="font-size:22px; color:var(--purple);">14</div>
            <div class="text-xs text-muted">Maintenance Items</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div>
      <!-- Waiting -->
      <div id="svc-waiting" class="card" style="text-align:center; padding:56px 24px;">
        <div style="font-size:52px; margin-bottom:16px;">ðŸ”§</div>
        <div class="font-display fw-700" style="font-size:18px; color:var(--text2); letter-spacing:1px;">AWAITING INPUT</div>
        <p class="text-sm text-muted" style="margin-top:8px;">Fill in vehicle details and click "Predict Maintenance".</p>
      </div>

      <!-- Loading -->
      <div id="svc-loading" style="display:none; text-align:center; padding:56px 24px;">
        <div class="spinner" style="width:36px; height:36px; margin:auto;"></div>
        <div class="text-muted text-sm" style="margin-top:16px;">Analyzing service requirements...</div>
      </div>

      <!-- Result -->
      <div id="svc-result" style="display:none;">
        <!-- Cost Hero -->
        <div class="card" style="border-color:rgba(88,166,255,.4); text-align:center; position:relative; overflow:hidden;">
          <div style="position:absolute;inset:-40%;background:radial-gradient(circle at center, rgba(88,166,255,.08), transparent 60%);pointer-events:none;"></div>
          <div class="text-xs text-muted" style="letter-spacing:2px; margin-bottom:8px;">PREDICTED SERVICE COST</div>
          <div class="font-display fw-700" style="font-size:52px; color:var(--accent);" id="svc-cost">â‚¹0</div>
          <div class="text-sm text-muted" style="margin-top:6px;">Based on vehicle profile & mileage (MAE Â±â‚¹404)</div>
          <div style="margin-top:12px; display:flex; justify-content:center; gap:12px;">
            <span id="svc-urgency-badge" class="badge">â€”</span>
            <span id="svc-items-count" class="badge badge-accent">â€”</span>
          </div>
        </div>

        <!-- Items needed -->
        <div class="card mt-16" id="svc-needed-card">
          <div class="card-head" style="color:var(--danger);">Items Requiring Replacement</div>
          <div class="maint-grid" id="svc-needed-grid"></div>
        </div>

        <!-- Items OK -->
        <div class="card mt-16">
          <div class="card-head" style="color:var(--success);">Items in Good Condition</div>
          <div class="maint-grid" id="svc-ok-grid"></div>
        </div>

        <!-- Maintenance Summary Table -->
        <div class="card mt-16">
          <div class="card-head">Full Maintenance Report</div>
          <table class="data-table" style="font-size:12px;">
            <thead>
              <tr><th>Item</th><th>Status</th><th>Probability</th></tr>
            </thead>
            <tbody id="svc-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadServiceSample() {
  document.getElementById('v-brand').value        = 'honda';
  document.getElementById('v-model').value        = 'jazz';
  document.getElementById('v-engine').value       = 'petrol';
  document.getElementById('v-region').value       = 'chennai';
  document.getElementById('v-year').value         = '2017';
  document.getElementById('v-mileage').value      = '45000';
  document.getElementById('v-mileage-range').value= '10000';
}

function clearServiceForm() {
  ['v-brand','v-model','v-engine','v-region','v-year','v-mileage-range'].forEach(id => {
    document.getElementById(id).selectedIndex = 0;
  });
  document.getElementById('v-mileage').value = '';
  document.getElementById('svc-waiting').style.display  = 'block';
  document.getElementById('svc-result').style.display   = 'none';
}

async function runServicePredict() {
  const brand   = document.getElementById('v-brand').value;
  const model   = document.getElementById('v-model').value;
  const engine  = document.getElementById('v-engine').value;
  const region  = document.getElementById('v-region').value;
  const year    = document.getElementById('v-year').value;
  const mileage = document.getElementById('v-mileage').value;
  const milRange= document.getElementById('v-mileage-range').value;

  if (!brand || !model || !engine || !region || !year || !mileage) {
    alert('Please fill all vehicle details.'); return;
  }

  const btn = document.getElementById('predict-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Predicting...';
  document.getElementById('svc-waiting').style.display  = 'none';
  document.getElementById('svc-result').style.display   = 'none';
  document.getElementById('svc-loading').style.display  = 'block';

  try {
    const res  = await fetch('/api/predict-service', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ brand, model, engine_type: engine, region,
                              make_year: year, mileage, mileage_range: milRange })
    });
    const data = await res.json();
    document.getElementById('svc-loading').style.display = 'none';
    renderServiceResult(data);
  } catch(e) {
    document.getElementById('svc-loading').style.display = 'none';
    alert('Error: ' + e.message);
  }

  btn.disabled = false; btn.innerHTML = 'ðŸ”§ Predict Maintenance';
}

function renderServiceResult(data) {
  if (!data.success) { alert('Error: ' + data.error); return; }

  document.getElementById('svc-cost').textContent = 'â‚¹' + data.predicted_cost.toLocaleString('en-IN');

  const urgBadge = document.getElementById('svc-urgency-badge');
  const colMap = { Low:'badge-success', Medium:'badge-warning', High:'badge-warning', Urgent:'badge-danger' };
  urgBadge.className = 'badge ' + (colMap[data.urgency] || 'badge-accent');
  urgBadge.textContent = data.urgency + ' Urgency';

  document.getElementById('svc-items-count').textContent =
    data.total_items_needed + ' of 14 items need replacement';

  // Needed grid
  const neededGrid = document.getElementById('svc-needed-grid');
  neededGrid.innerHTML = data.items_needed.length
    ? data.items_needed.map(it =>
        `<div class="maint-item needed">
           <span class="maint-dot"></span>
           <span>${it.label}<br><span class="text-xs text-muted">${it.probability}%</span></span>
         </div>`).join('')
    : '<p class="text-muted text-sm">No items require replacement âœ“</p>';

  document.getElementById('svc-needed-card').style.display =
    data.items_needed.length ? 'block' : 'none';

  // OK grid
  document.getElementById('svc-ok-grid').innerHTML =
    data.items_not_needed.map(it =>
      `<div class="maint-item ok">
         <span class="maint-dot"></span>
         <span>${it.label}<br><span class="text-xs text-muted">${(100 - it.probability).toFixed(1)}% OK</span></span>
       </div>`).join('');

  // Table
  const allItems = [...data.items_needed, ...data.items_not_needed];
  document.getElementById('svc-table-body').innerHTML = allItems.map(it => `
    <tr>
      <td>${it.label}</td>
      <td>${it.needed
        ? '<span class="badge badge-danger" style="font-size:10px;">REPLACE</span>'
        : '<span class="badge badge-success" style="font-size:10px;">OK</span>'}</td>
      <td>
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="flex:1; background:var(--bg3); border-radius:100px; height:4px; overflow:hidden;">
            <div style="height:100%; width:${it.probability}%; background:${it.needed ? 'var(--danger)' : 'var(--success)'}; border-radius:100px;"></div>
          </div>
          <span class="mono" style="font-size:11px; color:var(--text2); min-width:36px;">${it.probability}%</span>
        </div>
      </td>
    </tr>`).join('');

  document.getElementById('svc-result').style.display = 'block';
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Engine Scan ‚Äî VehicleAI{% endblock %}

{% block content %}
<div class="page-hero">
  <div class="overline">Module 01 ‚Äî Engine Diagnostics</div>
  <h1>Engine <span>Condition</span> Scanner</h1>
  <p>Enter real-time engine sensor data to instantly predict engine health using our Gradient Boosting ML classifier trained on 19,535 data points.</p>
</div>

<div class="section">
  <div style="display:grid; grid-template-columns:1.3fr 1fr; gap:28px; align-items:start;">

    <!-- INPUT FORM -->
    <div>
      <div class="card">
        <div class="card-head">Engine Parameters</div>
        <div class="form-grid" style="grid-template-columns:1fr 1fr;">

          <div class="field">
            <label>Engine RPM</label>
            <input type="number" id="f-rpm" placeholder="e.g. 1500" min="300" max="5000" value="1500">
            <span class="hint">Normal: 700‚Äì3000 RPM</span>
          </div>

          <div class="field">
            <label>Lub Oil Pressure (bar)</label>
            <input type="number" id="f-oil-p" placeholder="e.g. 3.5" step="0.01" value="3.5">
            <span class="hint">Normal: 2.0‚Äì6.0 bar</span>
          </div>

          <div class="field">
            <label>Fuel Pressure (bar)</label>
            <input type="number" id="f-fuel-p" placeholder="e.g. 14.5" step="0.01" value="14.5">
            <span class="hint">Normal: 8.0‚Äì25.0 bar</span>
          </div>

          <div class="field">
            <label>Coolant Pressure (bar)</label>
            <input type="number" id="f-cool-p" placeholder="e.g. 2.5" step="0.01" value="2.5">
            <span class="hint">Normal: 1.0‚Äì4.0 bar</span>
          </div>

          <div class="field">
            <label>Lub Oil Temp (¬∞C)</label>
            <input type="number" id="f-oil-t" placeholder="e.g. 80" step="0.1" value="80">
            <span class="hint">Normal: 60‚Äì100 ¬∞C</span>
          </div>

          <div class="field">
            <label>Coolant Temp (¬∞C)</label>
            <input type="number" id="f-cool-t" placeholder="e.g. 82" step="0.1" value="82">
            <span class="hint">Normal: 70‚Äì95 ¬∞C</span>
          </div>
        </div>

        <div style="margin-top:24px; display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn-primary" id="scan-btn" onclick="runEngineScan()">
            ‚ö° Run Engine Scan
          </button>
          <button class="btn btn-ghost" onclick="loadSample('normal')">Load Normal Sample</button>
          <button class="btn btn-ghost" onclick="loadSample('fault')">Load Fault Sample</button>
          <button class="btn btn-ghost" onclick="clearForm()">Clear</button>
        </div>
      </div>

      <!-- Parameter Reference -->
      <div class="card mt-16">
        <div class="card-head">Parameter Reference Guide</div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Parameter</th>
              <th>Healthy Range</th>
              <th>Warning Threshold</th>
              <th>Critical</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>Engine RPM</td><td class="text-success">700‚Äì3000</td><td class="text-warning">3000‚Äì4500</td><td class="text-danger">&gt;4500 or &lt;300</td></tr>
            <tr><td>Lub Oil Pressure</td><td class="text-success">2.0‚Äì6.0 bar</td><td class="text-warning">1.5‚Äì2.0</td><td class="text-danger">&lt;1.5 bar</td></tr>
            <tr><td>Fuel Pressure</td><td class="text-success">8‚Äì22 bar</td><td class="text-warning">6‚Äì8</td><td class="text-danger">&lt;6 bar</td></tr>
            <tr><td>Coolant Pressure</td><td class="text-success">1.0‚Äì4.0 bar</td><td class="text-warning">0.8‚Äì1.0</td><td class="text-danger">&lt;0.8 bar</td></tr>
            <tr><td>Lub Oil Temp</td><td class="text-success">60‚Äì100 ¬∞C</td><td class="text-warning">100‚Äì120</td><td class="text-danger">&gt;120 ¬∞C</td></tr>
            <tr><td>Coolant Temp</td><td class="text-success">70‚Äì95 ¬∞C</td><td class="text-warning">95‚Äì105</td><td class="text-danger">&gt;105 ¬∞C</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- RESULTS -->
    <div>
      <!-- Waiting State -->
      <div id="waiting-state" class="card" style="text-align:center; padding:48px 24px;">
        <div style="font-size:48px; margin-bottom:16px;">üîç</div>
        <div class="font-display fw-700" style="font-size:18px; color:var(--text2); letter-spacing:1px;">AWAITING SCAN</div>
        <p class="text-sm text-muted" style="margin-top:8px;">Enter engine parameters and click "Run Engine Scan" to get AI-powered diagnostics.</p>
      </div>

      <!-- Result Panel -->
      <div id="result-panel" class="result-panel">
        <div class="result-header" id="result-header">
          <span id="result-status">‚Äî</span>
          <span class="badge" id="result-badge">‚Äî</span>
        </div>
        <div class="result-body">
          <p id="result-msg" class="text-muted text-sm" style="margin-bottom:20px;"></p>

          <!-- Health Score Gauge -->
          <div style="display:flex; gap:20px; align-items:center; margin-bottom:20px; flex-wrap:wrap;">
            <div style="text-align:center;">
              <svg width="140" height="80" viewBox="0 0 140 80">
                <path d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="#21262d" stroke-width="10" stroke-linecap="round"/>
                <path id="gauge-arc" d="M 15 70 A 55 55 0 0 1 125 70" fill="none" stroke="#3fb950" stroke-width="10" stroke-linecap="round" stroke-dasharray="0 172" style="transition:stroke-dasharray 1s ease, stroke .5s;"/>
                <text x="70" y="65" text-anchor="middle" fill="#e6edf3" font-family="Rajdhani" font-size="20" font-weight="700" id="gauge-text">‚Äî</text>
                <text x="70" y="78" text-anchor="middle" fill="#6e7681" font-family="Inter" font-size="8">HEALTH %</text>
              </svg>
            </div>
            <div style="flex:1; min-width:120px;">
              <div style="margin-bottom:12px;">
                <div style="font-size:11px; letter-spacing:1px; color:var(--text3); margin-bottom:4px;">FAULT PROBABILITY</div>
                <div class="font-display fw-700" style="font-size:28px;" id="fault-pct">‚Äî</div>
              </div>
              <div>
                <div style="font-size:11px; letter-spacing:1px; color:var(--text3); margin-bottom:4px;">PREDICTION</div>
                <div class="font-display fw-700" style="font-size:18px;" id="condition-label">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Alert Level Indicator -->
          <div id="alert-row" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:16px;">
            {% for level in ['NORMAL','CAUTION','WARNING','CRITICAL'] %}
            <div id="alert-{{level}}" style="padding:8px; border-radius:6px; text-align:center; font-family:'Rajdhani',sans-serif; font-size:11px; font-weight:700; letter-spacing:1px; background:var(--bg3); border:1px solid var(--border); color:var(--text3); transition:all .3s;">
              {{ level }}
            </div>
            {% endfor %}
          </div>

          <!-- Recommendations -->
          <div id="recommendations" style="margin-top:20px; display:none;">
            <div style="font-size:11px; letter-spacing:1.5px; color:var(--text2); margin-bottom:10px; font-family:'Rajdhani',sans-serif; font-weight:700;">RECOMMENDATIONS</div>
            <div id="rec-list"></div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loading-state" style="display:none; text-align:center; padding:48px 24px;">
        <div class="spinner" style="width:32px; height:32px; margin:auto;"></div>
        <div class="text-muted text-sm" style="margin-top:16px;">Analyzing engine parameters...</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const SAMPLES = {
  normal: { rpm:1500, oil_p:3.5, fuel_p:14.5, cool_p:2.5, oil_t:80, cool_t:82 },
  fault:  { rpm:450,  oil_p:1.2, fuel_p:5.5,  cool_p:0.7, oil_t:125, cool_t:108 },
};

function loadSample(type) {
  const s = SAMPLES[type];
  document.getElementById('f-rpm').value   = s.rpm;
  document.getElementById('f-oil-p').value = s.oil_p;
  document.getElementById('f-fuel-p').value= s.fuel_p;
  document.getElementById('f-cool-p').value= s.cool_p;
  document.getElementById('f-oil-t').value = s.oil_t;
  document.getElementById('f-cool-t').value= s.cool_t;
}

function clearForm() {
  ['f-rpm','f-oil-p','f-fuel-p','f-cool-p','f-oil-t','f-cool-t'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('waiting-state').style.display = 'block';
  document.getElementById('result-panel').classList.remove('show');
}

async function runEngineScan() {
  const btn = document.getElementById('scan-btn');
  const payload = {
    'Engine rpm':        parseFloat(document.getElementById('f-rpm').value),
    'Lub oil pressure':  parseFloat(document.getElementById('f-oil-p').value),
    'Fuel pressure':     parseFloat(document.getElementById('f-fuel-p').value),
    'Coolant pressure':  parseFloat(document.getElementById('f-cool-p').value),
    'lub oil temp':      parseFloat(document.getElementById('f-oil-t').value),
    'Coolant temp':      parseFloat(document.getElementById('f-cool-t').value),
  };

  if (Object.values(payload).some(v => isNaN(v))) {
    alert('Please fill in all engine parameters.');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Scanning...';
  document.getElementById('waiting-state').style.display = 'none';
  document.getElementById('result-panel').classList.remove('show');
  document.getElementById('loading-state').style.display = 'block';

  try {
    const res  = await fetch('/api/predict-engine', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    document.getElementById('loading-state').style.display = 'none';
    renderEngineResult(data);
  } catch(e) {
    document.getElementById('loading-state').style.display = 'none';
    alert('Error: ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = '‚ö° Run Engine Scan';
}

const ALERT_STYLES = {
  NORMAL:   { bg:'rgba(63,185,80,.2)',   border:'var(--success)', color:'var(--success)' },
  CAUTION:  { bg:'rgba(240,136,62,.2)',  border:'var(--caution)', color:'var(--caution)' },
  WARNING:  { bg:'rgba(210,153,34,.2)',  border:'var(--warning)', color:'var(--warning)' },
  CRITICAL: { bg:'rgba(248,81,73,.2)',   border:'var(--danger)',  color:'var(--danger)'  },
};

const RECS = {
  NORMAL:   ['Continue regular maintenance schedule', 'Next service due per mileage plan', 'All parameters within specifications'],
  CAUTION:  ['Monitor parameters closely over next 500 km', 'Check oil level and top up if needed', 'Schedule a diagnostic within 2 weeks'],
  WARNING:  ['Schedule service appointment immediately', 'Avoid high-speed driving', 'Check coolant and oil levels daily'],
  CRITICAL: ['Stop vehicle when safe and call for assistance', 'Do not continue driving ‚Äî risk of engine damage', 'Contact nearest service centre immediately'],
};

function renderEngineResult(data) {
  if (!data.success) { alert('Error: ' + data.error); return; }

  const panel  = document.getElementById('result-panel');
  const col    = data.alert_color;
  panel.className = 'result-panel show ' + col;

  document.getElementById('result-header').innerHTML =
    `<span>${data.label}</span><span class="badge badge-${col === 'success' ? 'success' : col === 'warning' ? 'warning' : 'danger'}">${data.alert_level}</span>`;
  document.getElementById('result-msg').textContent = data.message;
  document.getElementById('fault-pct').textContent = data.fault_probability + '%';
  document.getElementById('fault-pct').style.color = col === 'success' ? 'var(--success)' : col === 'warning' ? 'var(--warning)' : 'var(--danger)';
  document.getElementById('condition-label').textContent = data.label;
  document.getElementById('condition-label').style.color = col === 'success' ? 'var(--success)' : 'var(--danger)';

  // Gauge
  const arc  = document.getElementById('gauge-arc');
  const txt  = document.getElementById('gauge-text');
  const full = 172;
  const dash = (data.health_score / 100) * full;
  arc.style.strokeDasharray = dash + ' ' + (full - dash);
  arc.style.stroke = col === 'success' ? '#3fb950' : col === 'warning' ? '#d29922' : '#f85149';
  txt.textContent = Math.round(data.health_score) + '%';

  // Alert levels
  ['NORMAL','CAUTION','WARNING','CRITICAL'].forEach(lvl => {
    const el = document.getElementById('alert-' + lvl);
    const st = ALERT_STYLES[lvl];
    if (lvl === data.alert_level) {
      el.style.background = st.bg;
      el.style.borderColor = st.border;
      el.style.color = st.color;
    } else {
      el.style.background = 'var(--bg3)';
      el.style.borderColor = 'var(--border)';
      el.style.color = 'var(--text3)';
    }
  });

  // Recommendations
  const recDiv = document.getElementById('recommendations');
  const recList = document.getElementById('rec-list');
  recDiv.style.display = 'block';
  recList.innerHTML = (RECS[data.alert_level] || []).map(r =>
    `<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;font-size:13px;color:var(--text2);">
       <span style="color:var(--accent);flex-shrink:0;margin-top:2px;">‚ñ∏</span>${r}
     </div>`
  ).join('');
}
</script>
{% endblock %}
